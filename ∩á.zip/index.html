<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø®Ø¯ÙˆÙ… | ÙƒÙ†ÙŠØ³Ø© Ø§Ø¨Ùˆ Ø³ÙŠÙÙŠÙ†</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #00e5ff;
            --secondary: #ffd700;
            --bg: #050505;
            --card-bg: #121212;
            --text: #ffffff;
            --danger: #ff4757;
            --success: #00ff88;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family:'Cairo',sans-serif; -webkit-tap-highlight-color:transparent; }

        body {
            background: var(--bg);
            background-image: radial-gradient(circle at 50% 10%, #1a1a1a 0%, #000 70%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        header {
            text-align: center;
            padding: 25px 20px;
            position: relative;
        }
        header h1 {
            color: var(--primary);
            font-size: 1.6rem;
            text-shadow: 0 0 20px rgba(0, 229, 255, 0.5);
            margin-bottom: 5px;
            font-weight: 900;
        }
        header p { color: #888; font-size: 0.9rem; letter-spacing: 1px; }

        .container {
            padding: 20px;
            flex: 1;
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            z-index: 2;
        }

        .card {
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            transform: translateZ(0);
        }
        
        .neon-line {
            position: absolute; top:0; left:0; width:100%; height:2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            box-shadow: 0 0 15px var(--primary);
        }

        .form-group { margin-bottom: 20px; text-align: right; }
        .form-label { display: block; color: #aaa; margin-bottom: 8px; font-size: 0.9rem; }
        
        input {
            width: 100%; padding: 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            color: #fff; font-size: 1.1rem; text-align: center;
            transition: 0.3s;
        }
        input:focus {
            border-color: var(--primary);
            background: rgba(0, 229, 255, 0.05);
            box-shadow: 0 0 15px rgba(0,229,255,0.1);
            outline: none;
        }

        .btn {
            width: 100%; padding: 16px; border-radius: 15px; border: none;
            font-weight: 800; font-size: 1.1rem; cursor: pointer;
            transition: 0.3s; margin-top: 10px;
            position: relative; overflow: hidden;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #00b8cc);
            color: #000;
            box-shadow: 0 5px 20px rgba(0,229,255,0.3);
        }
        .btn-primary:active { transform: scale(0.98); }
        
        .btn-outline {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            font-size: 0.9rem;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ­Ø°ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .strict-warning {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid rgba(255, 71, 87, 0.4);
            color: #ff6b81;
            padding: 15px;
            border-radius: 15px;
            font-size: 0.85rem;
            text-align: right;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .strict-warning strong {
            color: var(--danger);
            display: block;
            margin-bottom: 5px;
            font-size: 1rem;
        }

        /* Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ */
        .points-circle {
            width: 130px; height: 130px;
            border-radius: 50%;
            border: 2px dashed rgba(255, 215, 0, 0.3);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            margin: 0 auto 20px;
            position: relative;
        }
        .points-circle::before {
            content:''; position: absolute; inset: 5px; border-radius: 50%;
            border: 3px solid var(--secondary);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
            animation: spin 10s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .points-val { font-size: 3rem; font-weight: 900; color: var(--secondary); line-height: 1; text-shadow: 0 0 15px rgba(255,215,0,0.4); position: relative; z-index: 2; }
        .points-lbl { font-size: 0.85rem; color: #fff; opacity: 0.8; position: relative; z-index: 2; }

        .info-item {
            display: flex; justify-content: space-between; padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .info-item:last-child { border-bottom: none; }
        .info-label { color: #888; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .info-value { color: #fff; font-weight: 700; }

        .history-list { max-height: 300px; overflow-y: auto; margin-top: 10px; padding-right: 5px; }
        .history-list::-webkit-scrollbar { width: 4px; }
        .history-list::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        .history-item {
            background: linear-gradient(90deg, rgba(255,255,255,0.03), transparent);
            padding: 12px 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border-right: 3px solid var(--success);
            transition: 0.2s;
        }

        .golden-glass-box {
            margin: 30px auto 10px;
            padding: 20px;
            max-width: 90%;
            border-radius: 20px;
            background: rgba(255, 215, 0, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.1), inset 0 0 20px rgba(255, 215, 0, 0.05);
            text-align: center;
            position: relative;
            animation: floatBox 4s ease-in-out infinite;
        }
        @keyframes floatBox {
            0%, 100% { transform: translateY(0); box-shadow: 0 0 20px rgba(255, 215, 0, 0.1); }
            50% { transform: translateY(-8px); box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2); }
        }
        .golden-glass-box p { color: #fff; font-size: 0.8rem; opacity: 0.8; margin-bottom: 5px; }
        .golden-glass-box h3 {
            background: linear-gradient(to right, #ffd700, #fff, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.1rem;
            font-weight: 900;
        }
        
        .ticker-wrap {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #000; border-top: 1px solid var(--primary);
            height: 40px; overflow: hidden; display: flex; align-items: center;
            z-index: 100; box-shadow: 0 -5px 20px rgba(0, 229, 255, 0.15);
        }
        .ticker { display: inline-block; white-space: nowrap; padding-right: 100%; animation: ticker 20s linear infinite; }
        .ticker-item { display: inline-block; padding: 0 2rem; font-size: 0.9rem; color: #fff; font-weight: 600; }
        .ticker-item i { color: var(--secondary); margin-left: 5px; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(100%, 0, 0); } }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.6s ease; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(15px)} to{opacity:1;transform:translateY(0)} }

    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-church"></i> ÙƒÙ†ÙŠØ³Ø© Ø§Ø¨Ùˆ Ø³ÙŠÙÙŠÙ† </h1>
        <p>Ø®Ø¯Ù…Ø© Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø£Ø­Ø¯ - Ø·Ù†Ø·Ø§</p>
    </header>

    <div class="container">
        
        <div id="loading" style="text-align:center; color:var(--primary); margin-top:50px;">
            <i class="fas fa-circle-notch fa-spin fa-2x"></i>
            <p style="margin-top:15px; font-size:0.9rem;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù…Ù†...</p>
        </div>

        <div id="step-phone" class="card fade-in hidden">
            <div class="neon-line"></div>
            <h2 style="text-align:center; margin-bottom:20px;">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¬Ø¯ÙŠØ¯</h2>
            
            <div class="strict-warning">
                <i class="fas fa-exclamation-triangle"></i> <strong>ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹:</strong>
                ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ ÙÙ‚Ø·.
                <br>
                Ø³ÙŠØªÙ… Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„Ø£Ø¨Ø¯ØŒ ÙˆÙ„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† ÙØªØ­ Ø­Ø³Ø§Ø¨ Ø¢Ø®Ø± Ø£Ùˆ Ø§Ø³ØªØ¹Ø§Ø±Ø© Ù‡Ø§ØªÙ ØµØ¯ÙŠÙ‚ Ù„Ù„Ø¯Ø®ÙˆÙ„.
                <br>
                <span style="color:#fff; text-decoration:underline;">ÙƒÙ„ Ø¬Ù‡Ø§Ø² = Ø­Ø³Ø§Ø¨ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·.</span>
            </div>

            <div class="form-group">
                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¬Ù„</label>
                <input type="tel" id="inputPhone" placeholder="01xxxxxxxxx">
            </div>
            <button onclick="window.checkPhone()" class="btn btn-primary">
                Ù…ØªØ§Ø¨Ø¹Ø© <i class="fas fa-arrow-left" style="margin-right:5px;"></i>
            </button>
            
            <button onclick="window.showLoginDirect()" class="btn btn-outline" style="font-size:0.8rem; border:none; color:#777;">
                Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ Ø§Ø¶ØºØ· Ù‡Ù†Ø§
            </button>
        </div>

        <div id="step-confirm" class="card fade-in hidden">
            <div class="neon-line" style="background:linear-gradient(90deg, transparent, var(--success), transparent); box-shadow:0 0 15px var(--success);"></div>
            <div style="text-align:center;">
                <div style="width:80px; height:80px; background:rgba(255,255,255,0.05); border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center;">
                    <i class="fas fa-user-check" style="font-size:2.5rem; color:var(--success);"></i>
                </div>
                <h3 style="color:#aaa; font-size:0.9rem;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§</h3>
                <h2 id="foundName" style="color:#fff; margin:5px 0 20px; font-size:1.4rem;"></h2>
                
                <div id="confirmBtns" style="display:flex; gap:10px;">
                    <button onclick="window.confirmIdentity()" class="btn btn-primary">Ù†Ø¹Ù…ØŒ Ù‡Ø°Ø§ Ø£Ù†Ø§</button>
                    <button onclick="window.resetFlow()" class="btn btn-outline" style="border-color:var(--danger); color:var(--danger);">Ù„Ø³Øª Ø£Ù†Ø§</button>
                </div>

                <div id="passwordSetup" class="hidden" style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
                    <p style="color:var(--secondary); font-size:0.9rem; margin-bottom:15px;">
                        <i class="fas fa-lock"></i> Ø£Ù†Ø´Ø¦ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ø­Ù…Ø§ÙŠØ© Ù†Ù‚Ø§Ø·Ùƒ
                    </p>
                    <input type="password" id="newPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                    <button onclick="window.completeRegistration()" class="btn btn-primary" style="background:var(--success); box-shadow:0 5px 20px rgba(46, 213, 115, 0.3); color:#000;">
                        ØªØ£ÙƒÙŠØ¯ ÙˆØ­ÙØ¸ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    </button>
                </div>
            </div>
        </div>

        <div id="step-login" class="card fade-in hidden">
            <div class="neon-line"></div>
            <h3 style="text-align:center; margin-bottom:25px;">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø­Ø³Ø§Ø¨Ùƒ</h3>
            <div class="form-group">
                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input type="tel" id="loginPhone">
            </div>
            <div class="form-group">
                <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="loginPassword">
            </div>
            <button onclick="window.doLogin()" class="btn btn-primary">Ø¯Ø®ÙˆÙ„</button>
            <button onclick="window.resetFlow()" class="btn btn-outline" style="border:none;">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <div id="dashboard" class="fade-in hidden">
            <div class="card" style="text-align:center; padding-top:30px;">
                <div class="points-circle">
                    <span class="points-val" id="dashPoints">0</span>
                    <span class="points-lbl">Ù†Ù‚Ø·Ø©</span>
                </div>
                <h2 id="dashName" style="color:var(--primary); font-size:1.4rem;"></h2>
                <span id="dashSection" style="background:rgba(255,255,255,0.1); padding:5px 15px; border-radius:20px; font-size:0.8rem; color:#ccc; margin-top:5px; display:inline-block;"></span>
            </div>

            <div class="card">
                <div class="neon-line"></div>
                <h3 style="margin-bottom:20px; display:flex; align-items:center; gap:10px; font-size:1.1rem;">
                    <i class="fas fa-id-card" style="color:var(--primary);"></i> Ø¨ÙŠØ§Ù†Ø§ØªÙŠ
                </h3>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-phone"></i> Ø§Ù„Ù‡Ø§ØªÙ</span>
                    <span class="info-value" id="dashPhone"></span>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-map-marker-alt"></i> Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span>
                    <span class="info-value" id="dashAddress"></span>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom:15px; display:flex; align-items:center; gap:10px; font-size:1.1rem;">
                    <i class="fas fa-history" style="color:var(--success);"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±
                </h3>
                <div class="history-list" id="dashHistory"></div>
            </div>

            <div class="golden-glass-box">
                <p>Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ØªÙ…Øª Ø¨Ø±Ù…Ø¬ØªÙ‡ Ø¨ÙˆØ§Ø³Ø·Ø©</p>
                <h3>Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ / ÙØ§Ø±Ø³ Ù‡Ø§Ù†ÙŠ</h3>
            </div>
            
            <br><br>
        </div>

    </div>

    <div class="ticker-wrap hidden" id="newsTicker">
        <div class="ticker">
            <div class="ticker-item"><i class="fas fa-calendar-alt"></i> Ø§Ù„ÙŠÙˆÙ…: <span id="tickerDate"></span></div>
            <div class="ticker-item"><i class="fas fa-pray"></i> Ø§Ù„Ø±Ø¨ Ù†ÙˆØ±ÙŠ ÙˆØ®Ù„Ø§ØµÙŠ Ù…Ù…Ù† Ø£Ø®Ø§Ù</div>
            <div class="ticker-item"><i class="fas fa-check-circle"></i> ØªÙ… ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­</div>
            <div class="ticker-item"><i class="fas fa-star"></i> ÙˆØ§Ø¸Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ø²ÙŠØ§Ø¯Ø© Ù†Ù‚Ø§Ø·Ùƒ</div>
            <div class="ticker-item"><i class="fas fa-calendar-alt"></i> Ø§Ù„ÙŠÙˆÙ…: <span id="tickerDate2"></span></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBDiflMuCCQ-b1VvbFhUIPA8ojiB3P7F7U",
            authDomain: "maharty-wep.firebaseapp.com",
            projectId: "maharty-wep",
            storageBucket: "maharty-wep.firebasestorage.app",
            messagingSenderId: "1033568078173",
            appId: "1:1033568078173:web:5d86a5046e997b1349c0b4",
            measurementId: "G-HGBSDTZ720"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let tempUserDocId = null; 
        let tempUserData = null;

        window.onload = async () => {
            const todayStr = new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if(document.getElementById('tickerDate')) document.getElementById('tickerDate').innerText = todayStr;
            if(document.getElementById('tickerDate2')) document.getElementById('tickerDate2').innerText = todayStr;

            const savedUid = localStorage.getItem('makhdoum_uid');
            
            if (savedUid) {
                await loadDashboard(savedUid);
            } else {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('step-phone').classList.remove('hidden');
            }
        };

        // --- Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ ---
        window.checkPhone = async () => {
            const phoneInput = document.getElementById('inputPhone');
            const phone = phoneInput.value.trim();
            
            if(!phone) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");

            showLoading(true);
            try {
                const q = query(collection(db, "users"), where("phone", "==", phone));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    // Ø¥Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
                    alert("Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©! ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                    
                    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø®Ø§Ù†Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙÙˆØ±Ø§Ù‹
                    phoneInput.value = '';
                    showLoading(false); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                    showScreen('step-phone'); // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ù‡Ø§ØªÙ
                    
                } else {
                    const userDoc = querySnapshot.docs[0];
                    tempUserDocId = userDoc.id;
                    tempUserData = userDoc.data();

                    if(tempUserData.password) {
                        showLoading(false);
                        // ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹ ÙÙŠ Ø­Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯Ø®ÙˆÙ„
                        if(confirm("Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŸ")) {
                            window.showLoginDirect();
                            document.getElementById('loginPhone').value = phone;
                        } else {
                            // Ù„Ùˆ Ø¯Ø§Ø³ Cancel ÙŠØ±Ø¬Ø¹ Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                            showScreen('step-phone');
                        }
                    } else {
                        document.getElementById('foundName').innerText = tempUserData.name;
                        showScreen('step-confirm');
                        showLoading(false);
                    }
                }
            } catch(e) {
                console.error(e);
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
                showLoading(false);
                showScreen('step-phone'); // Ø§Ù„Ø¹ÙˆØ¯Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            }
        };
        // ------------------------------------------------

        window.confirmIdentity = () => {
            document.getElementById('confirmBtns').classList.add('hidden');
            document.getElementById('passwordSetup').classList.remove('hidden');
        };

        window.completeRegistration = async () => {
            const pass = document.getElementById('newPassword').value;
            if(!pass || pass.length < 4) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹");

            showLoading(true);
            try {
                const userRef = doc(db, "users", tempUserDocId);
                await updateDoc(userRef, { password: pass });
                localStorage.setItem('makhdoum_uid', tempUserDocId);
                await loadDashboard(tempUserDocId);
            } catch(e) {
                console.error(e);
                alert("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨");
                showLoading(false);
                showScreen('step-phone');
            }
        };

        window.doLogin = async () => {
            const phone = document.getElementById('loginPhone').value.trim();
            const pass = document.getElementById('loginPassword').value;

            if(!phone || !pass) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
            showLoading(true);

            try {
                const q = query(collection(db, "users"), where("phone", "==", phone));
                const querySnapshot = await getDocs(q);

                if(querySnapshot.empty) {
                    alert("Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­");
                    showLoading(false);
                    showScreen('step-login');
                    return;
                }

                const userDoc = querySnapshot.docs[0];
                const userData = userDoc.data();

                if(userData.password === pass) {
                    localStorage.setItem('makhdoum_uid', userDoc.id);
                    await loadDashboard(userDoc.id);
                } else {
                    alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©");
                    showLoading(false);
                    showScreen('step-login');
                }

            } catch(e) {
                console.error(e);
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
                showLoading(false);
                showScreen('step-login');
            }
        };

        async function loadDashboard(uid) {
            showLoading(true);
            try {
                const docRef = doc(db, "users", uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    document.getElementById('dashName').innerText = data.name;
                    document.getElementById('dashPoints').innerText = data.points || 0;
                    document.getElementById('dashSection').innerText = data.section || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    document.getElementById('dashPhone').innerText = data.phone || '-';
                    document.getElementById('dashAddress').innerText = data.address || '-';

                    const historyContainer = document.getElementById('dashHistory');
                    historyContainer.innerHTML = '';
                    
                    if(data.history && data.history.length > 0) {
                        const sortedHist = [...data.history].sort((a,b) => b.ts - a.ts);
                        sortedHist.forEach(h => {
                            let dateStr = new Date(h.ts).toLocaleDateString('ar-EG');
                            let timeStr = new Date(h.ts).toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
                            
                            let typeText ="Ø­Ø¶ÙˆØ±";
                            let ptsColor = "var(--success)";
                            let borderColor = "var(--success)";
                            
                            if (h.type === 'gift') {
                                typeText = "ğŸ Ù‡Ø¯ÙŠØ© Ø®Ø§ØµØ©";
                                ptsColor = "var(--secondary)";
                                borderColor = "var(--secondary)";
                            } else if (h.type === 'deduct') {
                                typeText = "âš ï¸ Ø®ØµÙ… Ù†Ù‚Ø§Ø·";
                                ptsColor = "var(--danger)";
                                borderColor = "var(--danger)";
                            }

                            historyContainer.innerHTML += `
                                <div class="history-item" style="border-right-color:${borderColor}">
                                    <div>
                                        <div style="font-weight:bold; color:#fff;">${typeText}</div>
                                        <div style="font-size:0.75rem; color:#888;">${dateStr}</div>
                                    </div>
                                    <div style="text-align:left;">
                                        <span style="color:${ptsColor}; font-weight:bold; dir='ltr'">${h.pts > 0 ? '+' : ''}${h.pts}</span>
                                        <div style="font-size:0.7rem; color:#666;">${timeStr}</div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        historyContainer.innerHTML = '<p style="text-align:center; color:#555; padding:10px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø¨Ø¹Ø¯</p>';
                    }

                    hideAll();
                    document.getElementById('dashboard').classList.remove('hidden');
                    document.getElementById('newsTicker').classList.remove('hidden');

                } else {
                    alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                    localStorage.removeItem('makhdoum_uid');
                    showLoading(false);
                    showScreen('step-phone');
                }
            } catch(e) {
                console.error(e);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                showLoading(false);
                showScreen('step-phone');
            }
        }

        window.showLoginDirect = () => showScreen('step-login');
        window.resetFlow = () => {
            tempUserDocId = null;
            document.getElementById('inputPhone').value = '';
            showScreen('step-phone');
        };

        function showScreen(id) {
            hideAll();
            document.getElementById(id).classList.remove('hidden');
        }

        function hideAll() {
            document.getElementById('step-phone').classList.add('hidden');
            document.getElementById('step-confirm').classList.add('hidden');
            document.getElementById('step-login').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('newsTicker').classList.add('hidden');
        }

        function showLoading(show) {
            if(show) {
                hideAll();
                document.getElementById('loading').classList.remove('hidden');
            } else {
                document.getElementById('loading').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
